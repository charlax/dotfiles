#!/usr/bin/env bash

set -Eeuo pipefail

PROGRAM_NAME=${0##*/}
APP=$EDITOR_GUI

USE_ZETTELKASTEN_FORMAT=${USE_ZETTELKASTEN_FORMAT:-0}

function usage {
    echo "Usage: $PROGRAM_NAME [-z/--zettelkasten] [--help/-h] [directory]"
    exit 1
}

while true; do
    case "${1:-}" in
        -h | --help)
            usage
            ;;
        -z | --zettelkasten)
            USE_ZETTELKASTEN_FORMAT=1
            shift 1
            ;;
        *)
            break
            ;;
    esac
done

date_value=$(gdate --iso-8601=seconds)
echo "Filename? (without .md)"
read title

# Handle folder
if [[ "${1-}" == "" ]]; then
    FOLDER="."
else
    FOLDER=$1
fi

if [[ $USE_ZETTELKASTEN_FORMAT -gt 0 ]]; then
    id=$(date +"%Y%m%d%H%M%S")
    filename="$FOLDER/$id $title.md"
else
    id=$(date +"%Y-%m-%d")
    filename="$FOLDER/$title $id.md"
fi

[[ -s $filename ]] && echo -e "Error: file already exists" && return 1

cat >"$filename" <<EOF
---
title: ${title}
date: ${date_value}
keywords:
---

# ${title}

EOF

echo "$filename"
$APP "+normal G$" +startinsert "$filename"
