#!/usr/bin/env python3

import argparse
import glob
import os
import subprocess
import sys
from pathlib import Path

sys.path.insert(0, str(Path(__file__).parent.parent))
import color  # noqa: E402

DIRECTORIES = ("~/Downloads", "~/Desktop")


def print_task(msg: str) -> None:
    print("\n")
    print(color.green(msg))


def listdir_nohidden(path):
    return glob.glob(os.path.join(path, "*"))


def run(cmd):
    print(cmd)
    subprocess.run(cmd, shell=True, check=True)


def run_maintenance_tasks():
    print_task("Running maintenance tasks")
    run("sudo periodic daily weekly monthly")


def clean_up_ruby():
    print_task("Cleaning up ruby")
    run("gem cleanup")


def clean_up_docker():
    print_task("Cleaning up Docker")
    run("docker system prune -af")


def empty_temp_dirs(is_dry_run: bool = False):
    directories = map(os.path.expanduser, DIRECTORIES)

    if is_dry_run:
        print("\nWould have removed:")

    for d in directories:
        if not listdir_nohidden(d):
            print(f"{d} is already empty")
            continue

        print_task(f"Emptying {d}")

        print(d)
        for f in listdir_nohidden(d):
            print(f"  {f}")

        if is_dry_run:
            continue

        run(f"rmtrash {d}/*")


def main(is_dry_run: bool, will_clean_up_docker: bool = False) -> None:
    empty_temp_dirs(is_dry_run)
    run_maintenance_tasks()
    clean_up_ruby()

    if will_clean_up_docker:
        clean_up_docker()


if __name__ == "__main__":
    parser = argparse.ArgumentParser(description="Delete Downloads and Desktop folders")
    parser.add_argument(
        "--dry-run", action="store_true", help="do not actually delete anything"
    )

    args = parser.parse_args()

    main(is_dry_run=args.dry_run)
