#!/usr/bin/env python3
"""
csv2python.py

Takes a CSV and Python script as input, call a ``handle()`` function in the
script repeatedly which each line of the CSV file.
"""

import argparse
import csv
import importlib.util
import inspect
import logging
import sys

logger = logging.getLogger("csv2python")

EXTRA_DOC = """

The Python file needs to have a handle() function accepting one or two
arguments.


    # row is a dictionary containing the row data.
    def handle(row):
        print(row['name'])

    # If the function accepts two arguments, the first one is the row
    # number (starts with 1).
    def handle(line_number, row):
        if line_number == 1:
            print('toaster_name,color')

"""


def get_script(script_filename: str):
    """Get the handle function from a filename."""
    spec = importlib.util.spec_from_file_location("handler", script_filename)
    script = importlib.util.module_from_spec(spec)
    spec.loader.exec_module(script)
    return script


def number_of_arguments(func) -> int:
    """Return the number of arguments."""
    return len(inspect.getfullargspec(func).args)


def eprint(*args, **kwargs):
    print(*args, file=sys.stderr, **kwargs)


def handle(handler, index: int, row) -> None:
    try:
        if number_of_arguments(handler) == 1:
            handler(row)
        else:
            handler(index, row)

    except KeyError:
        eprint("Got exception with line %d: %s" % (index, row))
        raise


def main(args: argparse.Namespace) -> None:
    """Render the template."""
    csv_file = csv.DictReader(args.csv)
    script = get_script(args.python_script)
    rows = [{k.strip(): v.strip() for k, v in row.items()} for row in csv_file]

    total = len(rows)
    logger.info("%d rows to handle.", total)

    # Call before hook.
    if hasattr(script, "before"):
        script.before()

    handler = getattr(script, args.function)

    if args.whole:
        handle(handler, -1, rows)
        return

    for index, line in enumerate(rows, start=1):
        if index == args.stop_after:
            logger.info("Stopping after %d iteration.", args.stop_after)
            break
        logger.info("Handling row %d/%d", index + 1, total)
        handle(handler, index, line)


if __name__ == "__main__":
    parser = argparse.ArgumentParser(
        description="Render the template using CSV data",
        epilog=EXTRA_DOC,
        formatter_class=argparse.RawTextHelpFormatter,
    )
    parser.add_argument(
        "csv", nargs="?", type=argparse.FileType("r"), default=sys.stdin
    )
    parser.add_argument("python_script", type=str)
    parser.add_argument("--stop-after", type=int, help="stop after x iteration")
    parser.add_argument(
        "--whole",
        action="store_true",
        default=False,
        help="pass the whole file as a list of dict to the function",
    )
    parser.add_argument(
        "--function",
        type=str,
        default="handle",
        help="handler function name (default: %(default)s)",
    )
    args = parser.parse_args()

    main(args)
